<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDHub Vercel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: scale(1.05); }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-green-500 cursor-pointer" onclick="goHome()">HDHub4u</h1>
            <input type="text" id="search" placeholder="Search..." 
                class="bg-gray-800 border border-gray-600 rounded px-4 py-2 w-full max-w-xs text-white"
                onkeypress="if(event.key === 'Enter') doSearch(this.value)">
        </header>

        <div id="content" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        <div id="loading" class="hidden text-center text-green-500 text-xl">Loading...</div>
    </div>

    <script>
        const content = document.getElementById('content');
        const loading = document.getElementById('loading');

        async function goHome() {
            loading.classList.remove('hidden');
            content.innerHTML = '';
            const res = await fetch('/api/search');
            const data = await res.json();
            renderGrid(data);
            loading.classList.add('hidden');
        }

        async function doSearch(q) {
            loading.classList.remove('hidden');
            content.innerHTML = '';
            const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            renderGrid(data);
            loading.classList.add('hidden');
        }

        function renderGrid(items) {
            content.innerHTML = items.map(item => `
                <div class="card bg-gray-800 rounded-lg overflow-hidden cursor-pointer" onclick="loadDetails('${encodeURIComponent(item.link)}')">
                    <img src="${item.img}" class="w-full h-64 object-cover">
                    <div class="p-3">
                        <h3 class="text-sm font-bold truncate">${item.title}</h3>
                    </div>
                </div>
            `).join('');
        }

        async function loadDetails(url) {
            loading.classList.remove('hidden');
            content.innerHTML = '';
            const res = await fetch(`/api/details?url=${url}`);
            const data = await res.json();
            
            content.innerHTML = `
                <div class="col-span-full grid md:grid-cols-[300px_1fr] gap-8">
                    <img src="${data.poster}" class="rounded-lg shadow-lg">
                    <div>
                        <h2 class="text-3xl font-bold mb-6">${data.title}</h2>
                        <div class="space-y-2">
                            ${data.links.map(l => `
                                <div class="flex justify-between bg-gray-800 p-4 rounded items-center">
                                    <span>${l.title}</span>
                                    <button onclick="resolve('${encodeURIComponent(l.url)}', this)" class="bg-green-600 px-4 py-2 rounded font-bold hover:bg-green-500">
                                        Generate Link
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            loading.classList.add('hidden');
        }

        async function resolve(url, btn) {
            const originalText = btn.innerText;
            btn.innerText = "Extracting...";
            btn.disabled = true;
            try {
                const res = await fetch(`/api/resolve?url=${url}`);
                const data = await res.json();
                
                if (data.streams && data.streams.length > 0) {
                    const linksHtml = data.streams.map(s => 
                        `<a href="${s.link}" target="_blank" class="block bg-blue-600 p-2 rounded mb-2 text-center text-sm">${s.server} (${s.filename || ''})</a>`
                    ).join('');
                    
                    const container = document.createElement('div');
                    container.className = "mt-4 p-4 bg-gray-900 rounded";
                    container.innerHTML = linksHtml;
                    btn.parentElement.appendChild(container);
                    btn.remove();
                } else {
                    alert("No streams found.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert("Error extracting.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        goHome();
    </script>
</body>
</html>
